{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "c3c0e0e5_c1dc944e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2022-08-16T13:45:42Z",
      "side": 1,
      "message": "IIRc my original change had Regular already, the change got the NULL added by waddlesplash and I\u0027ve added regular again beforehand in a latter change.\n\nAslong as the fonts keep Regular in this should be fine, but we depend on noto not changing this then.\n\nAdditionally we haven\u0027t updated moto fonts in quite some time :) (especially not emoji)\nmight be worthwile to check what the newer version has.",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b7fd323e_205ea7a8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000011
      },
      "writtenOn": "2022-08-16T13:49:12Z",
      "side": 1,
      "message": "Perhaps we should just use a R/W lock? Wouldn\u0027t that solve our problems here?",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e8878fa_6b64f2de",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000223
      },
      "writtenOn": "2022-08-16T14:20:29Z",
      "side": 1,
      "message": "If you mean adding a lock everyone should go through before writelocking the fallbacks, like the gFontManager one before getting styles, then yes, that\u0027s what the comment tries to explain and what I offered in my previous response. It\u0027s just that I thought locking was best avoided if possible.\n\nSo global lock and keep style 0 in case fonts change in the future?",
      "parentUuid": "b7fd323e_205ea7a8",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a523d039_801b39f5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000011
      },
      "writtenOn": "2022-08-16T14:45:37Z",
      "side": 1,
      "message": "I mean the problem this commit is trying to solve is a deadlock. But none of these modify the fonts in question, do they? So why can\u0027t we use read/write locks instead and only acquire a read lock here, thus avoiding any deadlocks and also improving performance?",
      "parentUuid": "9e8878fa_6b64f2de",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "af406d1a_aeebb99b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000223
      },
      "writtenOn": "2022-08-16T16:05:25Z",
      "side": 1,
      "message": "\u003e I mean the problem this commit is trying to solve is a deadlock. But none of these modify the fonts in question, do they?\n\nIt comes from the deadlock report, then I noticed style 0 is not needed (at least with our current fonts) and removing it (thus removing some of the font variants in the fallback list) also removes the deadlock possibility.\n\n\u003e So why can\u0027t we use read/write locks instead and only acquire a read lock here, thus avoiding any deadlocks and also improving performance?\n\nWhen we get here we need to writelock the fallbacks and the main font[0] because we are creating a glyph from the fallback. We would in fact only need the main font and the one fallback that will provide the glyph, but as that may change in the string run, it complicates things having to release and reacquire locks, and also it was discarded in [1]. But that was back then when I was young and didn\u0027t even understand 10% of what I was doing, so I think I\u0027ll revisit that idea.\n\n[0] except when called from ServerFont::GetHasGlyphs, when we are already readlocking, and now that I\u0027m reading what it calls it seems it doesn\u0027t need any lock.\n[1] https://review.haiku-os.org/c/haiku/+/3273",
      "parentUuid": "a523d039_801b39f5",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "92b8bf16_17e3dcd9",
        "filename": "src/servers/app/font/GlyphLayoutEngine.h",
        "patchSetId": 1
      },
      "lineNbr": 361,
      "author": {
        "id": 1000011
      },
      "writtenOn": "2022-08-15T20:41:35Z",
      "side": 1,
      "message": "Is it possible to express this as an assertion instead of as a long-winded comment?",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "df4b9bd8_de056d80",
        "filename": "src/servers/app/font/GlyphLayoutEngine.h",
        "patchSetId": 1
      },
      "lineNbr": 361,
      "author": {
        "id": 1000223
      },
      "writtenOn": "2022-08-16T09:07:33Z",
      "side": 1,
      "message": "I lack the knowledge or imagination to do it. All I can come up with is asserting that c \u003d\u003d 0 || (c \u003d\u003d 1 \u0026\u0026 strcmp(fontStyle, \"Regular\") \u003d\u003d 0) in the outer loop, but that would just be \"don\u0027t touch this code!\" with no explanation.\n\nI could add the global lock even if we don\u0027t need it now, if that\u0027s OK. I might also be able to rework all this so that at most two locks are held and they are ordered by their addresses, but that will probably complicate things and may have more lock activity.",
      "parentUuid": "92b8bf16_17e3dcd9",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "88c38fdd_a3ebc76e",
        "filename": "src/servers/app/font/GlyphLayoutEngine.h",
        "patchSetId": 1
      },
      "lineNbr": 361,
      "author": {
        "id": 1000011
      },
      "writtenOn": "2022-08-25T17:16:23Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "df4b9bd8_de056d80",
      "revId": "541bb3ace64836ae114778729d6ceb55d8917a4c",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    }
  ]
}