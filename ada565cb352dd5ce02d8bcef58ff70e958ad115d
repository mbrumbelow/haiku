{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "17989016_0298e4e6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-26T12:45:00Z",
      "side": 1,
      "message": "Hi, have added some of the people active in the forum topic, and other present in this kind of patches.\n\nSome comments:\n\n- Reused from ARM port:\n    - Existing var identifiers that don\u0027t comply with the identifier convention. Kept due consistence with rest of files reused\n    - There are KernelArgs incorporations just to cope with the build. This and other possible interfaces with the Kernel are WIP\n\n- Reused from Jaroslaw Pelczar ARM64 port\n    - Most of reused code(https://github.com/korli/haiku-jarek/tree/master/src/system/kernel/arch/aarch64) is seen also in freeBSD\n\n- EL2\n    - Use case covered: EFI is passing the control in EL2 and existing MMU configuration covers the physical map.\n    - Additional logging has been placed to be able to elaborate other scenarios\n\n- arch_mmu_post_efi_setup -\u003e SetVirtualAddressMap: Comments needed here. This part of code is commented out. It is not clear if Uboot implements properly the service, even not clear to me what is it actually doing, as memory mapping is previously done...\n\n- aarch64.h: Most of definitions here should be shared with the kernel. As the port advances file should dissapear.\n\n- platform_allocate_region() vs mmu_allocate_page(): The first gave me a memory range which has been already at loading binaries stage...\n",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8e71d536_5772dcf5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000341
      },
      "writtenOn": "2022-01-26T13:58:02Z",
      "side": 1,
      "message": "Wow yeah! This looks impressive.\n\nBefore any review comments... I noticed that this change is based off a commit from last October, so perhaps can you rebase and check that it still works as expected? Quite a few things changed since then, including the toolchain moving from gcc 8.3 to 11.2",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8d1ebf3f_cd99fd27",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-26T14:41:12Z",
      "side": 1,
      "message": "Thanks David,\n\nTrue, and I am also not happy with that. The reason I sticked there is that there were build problems for ARM64:\n\n    https://discuss.haiku-os.org/t/arm64-port-status/11224/137\n\nLooks I was lucky enough to clone at a point where I managed to get the minimal artifacs to be able to progress.\n\nHas the situation improved? (feel my fear)\n\nI would need only the EFI loader(haiku_loader.efi) and the kernel (kernel_arm64).",
      "parentUuid": "8e71d536_5772dcf5",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2b94f78d_3d383559",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000341
      },
      "writtenOn": "2022-01-28T09:47:43Z",
      "side": 1,
      "message": "I tried a build on latest master hrev55814. I had to add a stub for arch_convert_kernel_args() in arch_start.cpp (my bad, I haven\u0027t implemented it for arm64 in commit af90bfd3b back in December)\nI also had to stub config_manager_arch.c\n\nOnce that\u0027s done, I get a successful build.\n\nI was not able to try out this MMU initialization patch though, as the bootup fails for me at an earlier stage, right after the \"Welcome to the Haiku boot loader!\" printout. (I tried it in qemu).",
      "parentUuid": "8d1ebf3f_cd99fd27",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "759e2c2a_f7f06c25",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-28T12:21:23Z",
      "side": 1,
      "message": "\u003e I tried a build on latest master hrev55814. I had to add a stub for arch_convert_kernel_args() in arch_start.cpp (my bad, I haven\u0027t implemented it for arm64 in commit af90bfd3b back in December)\n\u003e I also had to stub config_manager_arch.c\n\u003e \n\u003e Once that\u0027s done, I get a successful build.\n\nOk thanks, same here, I will test again",
      "parentUuid": "2b94f78d_3d383559",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0b5a5019_570de65e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-28T16:40:56Z",
      "side": 1,
      "message": "\u003e I was not able to try out this MMU initialization patch though, as the bootup fails for me at an earlier stage, right after the \"Welcome to the Haiku boot loader!\" printout. (I tried it in qemu).\n\nTested on my side and unfortunatelly I also reproduced this, quite behind compared with \"jumping \u0026 executing the kernel\" :(\n\n    --\u003e exception\n    boot::Partition::Partition\n    add_partitions_for\n    add_partitions_for\n    get_boot_file_system\n    main\n    efi_main\n\nMaybe not the place for addressing the topic but any hint on which commit to look based on the stackframe?",
      "parentUuid": "759e2c2a_f7f06c25",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9a120035_9f8ab760",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000341
      },
      "writtenOn": "2022-01-28T16:59:03Z",
      "side": 1,
      "message": "Not sure if it is related to any specific commit, it could also be the change from gcc 8.3 to 11.2.\n\nAs I see now in loader/partitions.cpp there are calls to memset and atomic_add in Partition::Partition. The arm64 port seems to use a generic memset implementation so atomic_add might be a more likely suspect.\n\nUnfortunately the Exception Syndrome Register is not very helpful, I get the following printout in TianoCore:\n\nESR : EC 0x00  IL 0x1  ISS 0x00000000\n\nEC \u003d 00 means unknown reason.",
      "parentUuid": "0b5a5019_570de65e",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "04bd7b83_1268eeb3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-28T18:26:03Z",
      "side": 1,
      "message": "Great suspicion:\n\nin boot::Partition::Partition: \n\n 14998:       97ffc9f2        bl      7160 \u003cmemset\u003e\n 1499c:       f00001a2        adrp    x2, 4b000 \u003cgKernelArgs+0x838\u003e\n 149a0:       52800020        mov     w0, #0x1                        // #1\n 149a4:       9119c042        add     x2, x2, #0x670\n 149a8:       b8e00040        ldaddal w0, w0, [x2]\n 149ac:       b9002260        str     w0, [x19, #32]\n 149b0:       2a1403e0        mov     w0, w20\n 149b4:       97ffe73f        bl      e6b0 \u003cdup\u003e\n\nHe does not like ldaddal instruction(pattern b8e00040), my ELR points right in this instruction, X2 value has proper memory in my case.\n\nldaddal \u003d\u003e Atomic add on word or doubleword in memory.",
      "parentUuid": "9a120035_9f8ab760",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7efc18b0_abf525e6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000341
      },
      "writtenOn": "2022-01-28T18:41:55Z",
      "side": 1,
      "message": "ARM documentation says LDADDAL is supported in ARMv8.1 and later.\n\nThis explains why I got an exception when I tried it in qemu with Cortex-A57 (i.e. ARMv8) emulation.\n\nThe compile flags in build/jam/ArchitectureRules might be a bit too ambitious:\n\ncase arm64 : archFlags +\u003d -march\u003darmv8.2-a+fp16 ;",
      "parentUuid": "04bd7b83_1268eeb3",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "26044f55_a7ac4173",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000341
      },
      "writtenOn": "2022-01-29T09:22:48Z",
      "side": 1,
      "message": "If I modify archFlags like this, I get a bootloader menu:\n\ncase arm64 : archFlags +\u003d -march\u003darmv8-a+fp16 -mno-outline-atomics ;\n\n(don\u0027t ask me why we need no-outline-atomics, I just did some googling)\n\n\nHowever, kernel loading fails with \"Couldn\u0027t find both text and data segment!\"",
      "parentUuid": "7efc18b0_abf525e6",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "141684ec_ac7c3454",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-29T13:31:45Z",
      "side": 1,
      "message": "\u003e The compile flags in build/jam/ArchitectureRules might be a bit too ambitious:\n\u003e \n\u003e case arm64 : archFlags +\u003d -march\u003darmv8.2-a+fp16 ;\n\nI am using currently a real A53 planning A72(like the one used RPI4?) later on (both ARMv8.0) \n\nAfter looking at this list, I think armv8.2 would be too restrictive:\n\n   https://en.wikipedia.org/wiki/Comparison_of_ARMv8-A_cores\n\n\u003e case arm64 : archFlags +\u003d -march\u003darmv8-a+fp16 -mno-outline-atomics ;\n\n   https://www.rowleydownload.co.uk/arm/documentation/gnu/as/AArch64-Extensions.html\n\nAccording to this, fp16 also reguires armv8.2\n\n\u003e (don\u0027t ask me why we need no-outline-atomics, I just did some googling)\n\nI also could not build without it (missing __aarch64_ldadd4_acq_rel).\nI think it has sense by the description:\n\n    https://gcc.gnu.org/onlinedocs/gcc/AArch64-Options.html\n\n\"\"if not, they will use the load/store-exclusive instructions that are present in the base ARMv8.0 ISA\"\"\n\nI compiled in my side then with \n\n    -march\u003darmv8-a -mno-outline-atomics\n\nAnd I see the LDADDAL instruction replaced by a pair of ldaxr \u0026 stlxr instructions, as well being able to reach the end of the build. \nWill test in the target later on.\n\nIn the commit this was introduced @Fredrik comments about problems relating FP \u0026 POSIX ...",
      "parentUuid": "26044f55_a7ac4173",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33eae453_2d665cc4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-29T15:34:37Z",
      "side": 1,
      "message": "\u003e I compiled on my side with \n\u003e \n\u003e     -march\u003darmv8-a -mno-outline-atomics\n\u003e \n\u003e I see the LDADDAL instruction replaced by a pair of ldaxr \u0026 stlxr instructions, as well being able to reach the end of the build. \n\u003e Will test in the target later on.\n\nConfirmed, I reach the same point where I was(reaching kernel) with this options.",
      "parentUuid": "141684ec_ac7c3454",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0b8765de_b3b86a49",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000021
      },
      "writtenOn": "2022-01-29T16:15:57Z",
      "side": 1,
      "message": "Ah so it was 8.2 because of fp16. There was some real horrible things I had to go through because of 16 bit fp. My QEMU  setup used -cpu cortex-a57 -M virt -bios QEMU_EFI.fd btw.\n\nThe problem is zstd (and I think some other lib) for ARM64 needs to be reimplemented if you don\u0027t enable fp16. Once you update your tree to where zstd is needed you will hit this. The fp16 flag is for gcc to provide fp16 headers correctly. I didn\u0027t feel like rewriting parts of gcc: https://discuss.haiku-os.org/t/arm64-port-status/11224/133\n\nSo from the pain I had I think you should keep it at 8.2 until everything is working, then start back-porting if you have the time and energy for that.",
      "parentUuid": "33eae453_2d665cc4",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "55e51f6d_7825e2b0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000359
      },
      "writtenOn": "2022-01-30T00:27:32Z",
      "side": 1,
      "message": "\u003e The problem is zstd (and I think some other lib) for ARM64 needs to be reimplemented if you don\u0027t enable fp16. Once you update your tree to where zstd is needed you will hit this.\n\nMy build(@minimum-mmc) is fresh \u0026 up to date: https://pastebin.com/08V2M4RS \n\nI\u0027d like to reproduce the zstd problem to have the complete picture, otherwise, these libs(core to haiku?) are forcing us to discard a whole set of popular armv8 processors(A53/A57/A72/...).\n\nWhich components core and non-core depend on that lib?\n\nThe topic gets complex, is it ok to go on here?",
      "parentUuid": "0b8765de_b3b86a49",
      "revId": "ada565cb352dd5ce02d8bcef58ff70e958ad115d",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    }
  ]
}