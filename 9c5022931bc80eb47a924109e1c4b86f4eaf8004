{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "6b6e4ac7_78cde850",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000011
      },
      "writtenOn": "2022-07-26T20:40:17Z",
      "side": 1,
      "message": "Do we really need to do this? Why not just handle the case in uselocale() instead?",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0151310f_51e450c8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000391
      },
      "writtenOn": "2022-07-27T00:48:32Z",
      "side": 1,
      "message": "- If we handle the case in uselocale, some code for retrieving the POSIX locale (in libroot-icu) will need to be duplicated to create our own C databridge.\n- Using `LocaleBackend::CreateBackend();` is possible, but it may fail (when libroot-icu cannot be detected), and POSIX does not allow the function to fail for a valid locale_t object.\n\n\nIn my opinion this is the best fix. It removes a lot of complicated NULL checking logic and removes special cases, making the code much simpler.",
      "parentUuid": "6b6e4ac7_78cde850",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "83cfbc1f_4eddd8de",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000001
      },
      "writtenOn": "2022-07-27T07:28:38Z",
      "side": 1,
      "message": "The code without backend is used when bootstrapping Haiku on a new architecture. In that situation, ICU is not available at all, and so there is fallback code to do everything \"manually\", for the C/POSIX locale only.\n\nThis code is complicated, yes, but there\u0027s a reason for that: ICU has to be optional.\n\nWhat are the implications of this change in that situation?",
      "parentUuid": "0151310f_51e450c8",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4b88a080_96b67daa",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000391
      },
      "writtenOn": "2022-07-27T07:32:03Z",
      "side": 1,
      "message": "ICU is still optional.\n\nIt is only not optional when dealing with locale_t objects (stuff that I added in the last PR).\n\nUnless bootstrapping has been updated to use the locale_t API, then there\u0027s no reason anything would break.",
      "parentUuid": "83cfbc1f_4eddd8de",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a88b908a_1cbe8d94",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000172
      },
      "writtenOn": "2022-07-27T12:01:26Z",
      "side": 1,
      "message": "Does it affect process startup speed?",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c0f80c78_41e0d553",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000391
      },
      "writtenOn": "2022-07-27T12:42:39Z",
      "side": 1,
      "message": "It does NOT, when tested on a Haiku installation.\n\nTheoretically, it cannot affect process startup speed. The optimization that was removed only applies when a program creates a new locale_t object using the new newlocale or duplocale function that is set to the \"C\" locale.\n\nApps that do not rely on the locale_t API added in the last patch are unaffected by changes in these functions. libroot does not have any static locale_t object that I know of.",
      "parentUuid": "a88b908a_1cbe8d94",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0e152fec_ecda3bf4",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000011
      },
      "writtenOn": "2022-07-27T16:24:57Z",
      "side": 1,
      "message": "I think there are some applications and libraries in the core bootstrap set that may use locale_t if it is available (e.g. coreutils.) Thus we need to have these APIs continue to function even if ICU is not available. So, let\u0027s add the necessary fallbacks to uselocale.\n\nWhat code do you refer to that needs to be duplicated? Can\u0027t we just shift it into libroot entirely?\n\nAnd, why or how would the function fail? I guess I don\u0027t see what the complexity here is.",
      "parentUuid": "4b88a080_96b67daa",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8099c15a_8529e0d7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000391
      },
      "writtenOn": "2022-07-27T16:37:14Z",
      "side": 1,
      "message": "\u003e What code do you refer to that needs to be duplicated? Can\u0027t we just shift it into libroot entirely?\n\nhttps://xref.landonf.org/source/xref/haiku/src/system/libroot/add-ons/icu/ICULocaleBackend.cpp#417\n\nWe\u0027ll need to create a POSIX locale backend and make that backend fill a data bridge with POSIX locale values. We can avoid creating a locale backend but then we\u0027ll have to initialize a data bridge ourselves.\n\nThe global locale cannot be used because we\u0027re not sure that it\u0027s still set to the POSIX locale.\n \n\u003e And, why or how would the function fail? \n\nConstruction of a locale backend calls this function: https://xref.landonf.org/source/xref/haiku/src/system/libroot/posix/locale/LocaleBackend.cpp#85\nIt attempts to load functions from libroot-addon-icu: https://xref.landonf.org/source/xref/haiku/src/system/libroot/posix/locale/LocaleBackend.cpp#36\nWhich may fail if the library is not available.\n\n\u003e I guess I don\u0027t see what the complexity here is.\n\nSome of the \"complexity\" here is my fault, and I\u0027m still trying to find a better way.\n\nMaybe this solution may work:\n- Keep all the NULL backend optimization code from the previous patchset.\n- If uselocale cannot create a backend AND LocaleBackend::CreateBackend() fails, this is probably due to the fact that libroot-icu is missing. If the addon is missing, the global locale can\u0027t be anything other than the C locale so we don\u0027t have to set anything at all.\n\nThis covers various applications setting the locale to \"C\" at startup (like ImageMagick) to ensure that the C runtime behaves like expected.\nHowever, LocaleBackend::CreateBackend() might also fail when we\u0027re running out of memory, and POSIX doesn\u0027t seem to allow that. uselocale may only fail when an invalid locale_t is passed:\n\nhttps://pubs.opengroup.org/onlinepubs/9699919799/functions/uselocale.html\n\n\u003e The uselocale() function may fail if:\n\u003e [EINVAL]\n\u003e newloc is not a valid locale object and is not (locale_t)0.",
      "parentUuid": "0e152fec_ecda3bf4",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bec58bcc_31f22ec3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000011
      },
      "writtenOn": "2022-07-27T16:40:21Z",
      "side": 1,
      "message": "I like what you suggest under \"Maybe this solution may work\", let\u0027s go with that.\n\nI don\u0027t think failing with ENOMEM is an issue here. Applications generally check for any error, not just the ones POSIX explicitly specifies. There are other places where we allow failures that aren\u0027t always enumerated by POSIX.",
      "parentUuid": "8099c15a_8529e0d7",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9366b3c2_0700fc28",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000391
      },
      "writtenOn": "2022-07-27T16:41:03Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "bec58bcc_31f22ec3",
      "revId": "9c5022931bc80eb47a924109e1c4b86f4eaf8004",
      "serverId": "40b9299a-d8a8-485d-9b01-e6d3f45eefb5"
    }
  ]
}